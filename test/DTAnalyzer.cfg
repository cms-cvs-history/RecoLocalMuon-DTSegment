##
# Test the production of the complete chain:
# from digi to RecSegment 4D, through RecHit1D and RecSegment2D
# starting from real cosmic data from commissioning
# Up to now only the Linear Drift alogo is available for the
# commisioning data.
##

process testDTAnalyzer  = {

############################################################################################	
#			F I L E   R E A D E R 
############################################################################################	

# Event Formatter
  source = PoolSource{
## _Input_ ##
    untracked vstring fileNames = {
#########################################################    
# N.B: if you are accessing all these files from lxcmssrv1 , lxcmssrv2 or lxcmssrv3
# the correct path is:
# "file:/cms5/data/....ect."
#########################################################	 
#   MTCC Phase 2 :
# B = 0, DT only run ("Lorentz trigger") ==============================================
# ** edit me ***
# "file:/cms5/data/MTCC/Phase2/00004446/mtcc.00004446.A.testStorageManager_0.0.root",
# "file:/cms5/data/MTCC/Phase2/00004446/mtcc.00004446.A.testStorageManager_0.1.root",
# "file:/cms5/data/MTCC/Phase2/00004446/mtcc.00004446.A.testStorageManager_0.2.root",
# "file:/cms5/data/MTCC/Phase2/00004446/mtcc.00004446.A.testStorageManager_0.3.root",
# "file:/cms5/data/MTCC/Phase2/00004446/mtcc.00004446.A.testStorageManager_0.4.root"
#
# B = 0, RPC trigger run  ==============================================
# "file:/cms5/data/MTCC/Phase2/00004333/mtcc.00004333.A.testStorageManager_0.0.root",
# "file:/cms5/data/MTCC/Phase2/00004333/mtcc.00004333.A.testStorageManager_0.1.root",
# "file:/cms5/data/MTCC/Phase2/00004333/mtcc.00004333.A.testStorageManager_0.2.root",
# "file:/cms5/data/MTCC/Phase2/00004333/mtcc.00004333.A.testStorageManager_0.3.root",
# "file:/cms5/data/MTCC/Phase2/00004333/mtcc.00004333.A.testStorageManager_0.4.root"
# new RPC timing          
#         "file:/lxcdesrv/data/MTCC/Phase2/00004269/mtcc.00004269.A.testStorageManager_0.3.root",
#         "file:/lxcdesrv/data/MTCC/Phase2/00004269/mtcc.00004269.A.testStorageManager_0.4.root",
#         "file:/lxcdesrv/data/MTCC/Phase2/00004269/mtcc.00004269.A.testStorageManager_0.8.root",
#         "file:/lxcdesrv/data/MTCC/Phase2/00004269/mtcc.00004269.A.testStorageManager_0.9.root",
#         "file:/lxcdesrv/data/MTCC/Phase2/00004269/mtcc.00004269.A.testStorageManager_0.10.root"
# 
#    Phase2, B= 2 T =================================================================
#    
#
# B = 3.8 T  ===================================================                                  
#   CSC  singles,all stations, DT MB1 pointing
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.1.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.2.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.3.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.4.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.5.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.6.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.7.root",
#     "file:/lxcdesrv/data/MTCC/Phase2/00004018/mtcc.00004018.A.testStorageManager_0.0.root"
#   CSC singles all stations, DT MB1_neg_pointing_ tolerance 1
#  
#   "file:/lxcdesrv/data/MTCC/Phase2/00004045/mtcc.00004045.A.testStorageManager_0.0.root",
#   "file:/lxcdesrv/data/MTCC/Phase2/00004045/mtcc.00004045.A.testStorageManager_0.1.root",
#   "file:/lxcdesrv/data/MTCC/Phase2/00004045/mtcc.00004045.A.testStorageManager_0.2.root",
#   "file:/lxcdesrv/data/MTCC/Phase2/00004045/mtcc.00004045.A.testStorageManager_0.3.root",
#   "file:/lxcdesrv/data/MTCC/Phase2/00004045/mtcc.00004045.A.testStorageManager_0.4.root",
#   "file:/lxcdesrv/data/MTCC/Phase2/00004045/mtcc.00004045.A.testStorageManager_0.5.root"
#
      "file:/cms5/data/MTCC/Phase2/00004181/mtcc.00004181.A.testStorageManager_0.0.root",   
      "file:/cms5/data/MTCC/Phase2/00004181/mtcc.00004181.A.testStorageManager_0.1.root",
      "file:/cms5/data/MTCC/Phase2/00004181/mtcc.00004181.A.testStorageManager_0.2.root",
      "file:/cms5/data/MTCC/Phase2/00004181/mtcc.00004181.A.testStorageManager_0.3.root",
      "file:/cms5/data/MTCC/Phase2/00004181/mtcc.00004181.A.testStorageManager_0.4.root",
      "file:/cms5/data/MTCC/Phase2/00004181/mtcc.00004181.A.testStorageManager_0.5.root"  
    }  
# untracked int32 firstEvent = 0
    untracked int32 maxEvents = 1000
      untracked uint32 debugVebosity = 10
      untracked bool   debugFlag     = true
  }


############################################################################################	
#
#			D T   U N P A C K I N G  
#
############################################################################################	


# Data Unpacker
  module dtunpacker = DTUnpackingModule{ 
    string dataType = "DDU" 
      untracked bool debugMode = false 
      untracked bool readingDDU = true 
      untracked bool isRaw = false 
      untracked bool globalDAQ = true
      untracked int32 dduID = 770
      untracked bool performDataIntegrityMonitor = false 
      untracked bool writeSC = true 
  }

############################################################################################	
#
#			D T   M A P P I N G
#
############################################################################################

# Mapping of the channels
  es_source mapping = PoolDBESSource {
    VPSet toGet = {
      {
        string record = "DTReadOutMappingRcd" 
          string tag = "MTCCMap"
      }
    }
    bool loadAll = true
#	     string connect = "sqlite_file:/afs/cern.ch/cms/Physics/muon/CMSSW/DT/SQLLite_070/commissioning/wheel2/mb3_10.db"
#	     untracked string catalog = "file:/afs/cern.ch/cms/Physics/muon/CMSSW/DT/SQLLite_070/commissioning/wheel2/mb3Catalog.xml"
      string connect = "sqlite_file:MTCCMap.db"
      untracked string catalog = "file:MTCCCatalog_phase2.xml"
      string timetype = "runnumber" 
      untracked uint32 authenticationMethod = 0
      untracked uint32 messagelevel = 0
  }


############## Geometry ##############################################

# No Mag Field for the Commissioning Data
  include "Geometry/CMSCommonData/data/cmsMTCCGeometryXML.cfi" 
    include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"


# include "Geometry/MuonCommonData/data/muonIdealGeometryXML.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
    include "Geometry/DTGeometry/data/dtGeometry.cfi"
#include "Geometry/CSCGeometry/data/cscGeometry.cfi"
#include "Geometry/CSCGeometry/data/cscGeometryInMTCC.cfi"
    include "Geometry/RPCGeometry/data/rpcGeometry.cfi"
    include "Geometry/CommonDetUnit/data/bareGlobalTrackingGeometry.cfi"
    include "RecoTracker/GeometryESProducer/data/TrackerRecoGeometryESProducer.cfi"

# ES producer
    include "RecoMuon/DetLayers/data/muonDetLayerGeometry.cfi"

############################################################################################	
#
#			D T   T I M E   C A L I B R A T I O N  
#
############################################################################################	


# TTrig from DB
    es_source ttrig = PoolDBESSource {
      VPSet toGet = {
        {
          string record = "DTTtrigRcd" 
# phase 1
#      string tag = "tTrigMTCC"
# phase 2:
#      string tag = "ttrigMTCC"
            string tag = "ttrig"
        }
      } 
      bool loadAll = true
# ** edit me ***		     
# string connect = "sqlite_file:/lxcdesrv/data/MTCC/Phase2/databases/00004045/ttrig_run4045.db"
        string connect = "sqlite_file:/cms5/data/MTCC/Phase2/databases/00004181/ttrig_run4181.db"
# string connect = "sqlite_file:/cms5/data/MTCC/Phase2/databases/00004333/tTrig4333_RPC.db"
# string connect = "sqlite_file:/lxcdesrv/data/MTCC/Phase2/databases/00004269/ttrig_run4269.db"
# string connect = "sqlite_file:/cms5/data/MTCC/Phase2/databases/00004446/ttrig_run4446.db"
        untracked string catalog = "file:MTCCCatalog_phase2.xml"
        string timetype = "runnumber" 
        untracked uint32 authenticationMethod = 0		
        untracked uint32 messagelevel = 0
    }


# T0 from DB
  es_source t0 = PoolDBESSource {
    VPSet toGet = {
      {
        string record = "DTT0Rcd" 
#                          string tag = "commissioning_t0"
          string tag = "t0MTCC"
      }
    }
    bool loadAll = true
#                           string connect = "sqlite_file:/afs/cern.ch/cms/Physics/muon/CMSSW/DT/SQLLite_070/t0/t0_W+2+1.db"
#                           untracked string catalog = "file:/afs/cern.ch/cms/Physics/muon/CMSSW/DT/SQLLite_070/t0/t0_W+2+1catalog.xml"
      string connect = "sqlite_file:t0MTCC.db"
      untracked string catalog = "file:MTCCCatalog_phase2.xml"
      string timetype = "runnumber" 
      untracked uint32 authenticationMethod = 0		
      untracked uint32 messagelevel = 0
  }


############################################################################################	
#
#			D T   R E C O N S T R U C T I O N
#
############################################################################################	

  include "RecoLocalMuon/DTRecHit/data/DTLinearDriftAlgo_CosmicData.cfi"

## _Vdrift1D_ ##
    include "RecoLocalMuon/DTRecHit/data/dt1DRecHits_LinearDrift_CosmicData.cfi"
    replace DTLinearDriftAlgo_CosmicData.recAlgoConfig.driftVelocityMB1W1 = 0.00573
#	replace dt1DRecHits.debug = true
#	replace dt1DRecHits.recAlgoConfig.debug = true
#	replace dt1DRecHits.recAlgoConfig.tTrigModeConfig.debug = true

## _Vdrift2D_ ##
    include "RecoLocalMuon/DTSegment/data/dt2DSegments_CombPatternReco2D_LinearDrift_CosmicData.cfi"
    replace DTCombinatorialPatternReco2DAlgo_LinearDrift_CosmicData.Reco2DAlgoConfig.nUnSharedHitsMin = 2
    replace DTCombinatorialPatternReco2DAlgo_LinearDrift_CosmicData.Reco2DAlgoConfig.nSharedHitsMax = 2

## _4DAlgo ##
    include "RecoLocalMuon/DTSegment/data/dt4DSegments_CombPatternReco4D_LinearDrift_CosmicData.cfi"
    replace DTCombinatorialPatternReco4DAlgo_LinearDrift_CosmicData.Reco4DAlgoConfig.nUnSharedHitsMin = 2
    replace DTCombinatorialPatternReco4DAlgo_LinearDrift_CosmicData.Reco4DAlgoConfig.nSharedHitsMax = 2

## _all1DHits_ ##	
# CAVEAT if all1DHits = false: 
#	1- the file must contain the 2D segments
#	2- defined only for CombinatorialPatternReco
#	replace DTSegment4DProducer.Reco4DAlgoConfig.AllDTRecHits = false

## StandAlone
## Geometry
    include "Geometry/CommonDetUnit/data/globalTrackingGeometry.cfi"

    include "RecoMuon/MuonSeedGenerator/data/CosmicMuonSeedProducer.cfi"
    replace CosmicMuonSeed.EnableCSCMeasurement = false
    include "RecoMuon/CosmicMuonProducer/data/CosmicMuonProducer.cfi"
    replace CosmicMuon.TrajectoryBuilderParameters.EnableCSCMeasurement = false
    replace CosmicMuon.TrajectoryBuilderParameters.EnableRPCMeasurement = false

## _Reader_ ##
    module DTAnalyzer = DTAnalyzer {
      bool isMC = false
        untracked bool debug = false
        bool LCT_RPC = false
        bool LCT_DT = true
        bool LCT_CSC = false
        untracked string rootFileName = "DTAnalyzer.root"
        string DTLocalTriggerLabel = "dtunpacker"
        string recHits1DLabel = "dt1DRecHits"
        string recHits2DLabel = "dt2DSegments"
        string recHits4DLabel = "dt4DSegments"
# The module to be used for ttrig synchronization and its paraemter set
        untracked string tTrigMode = 'DTTTrigSyncFromDB'
        untracked PSet tTrigModeConfig = {
          untracked bool debug = false
# The ttrig from the time box fit is defined as mean + kFactor * sigma
            double kFactor = -1.3
# The velocity of signal propagation along the wire (cm/ns)
            double vPropWire = 24.4
# Switch on/off the TOF correction from pulses
            bool doT0Correction = true   
# Switch on/off the TOF correction for particles
            bool doTOFCorrection = false 
# Switch on/off the correction for the signal propagation along the wire
            bool doWirePropCorrection  = false 
        }
      string SALabel = "CosmicMuon"
    }

  module out = PoolOutputModule {
    untracked string fileName ="rechit4D.root"
  }

# avoid printout at each event...
  service = MessageLogger {
    untracked vstring destinations = { "cout" }
    untracked vstring debugModules = { "*" }
    untracked PSet cout = {
      untracked string threshold = "WARNING"
        untracked bool noLineBreaks = true
        untracked PSet WARNING = {untracked int32 limit = 0 }
    }
  }


## iguana
  include "VisFramework/VisApplication/data/iguana-dt.cfi"

  ##  service = Timing{}


## _ExecPath_ ##
    path p = {dtunpacker, dt1DRecHits, dt2DSegments, dt4DSegments, CosmicMuonSeed, CosmicMuon, DTAnalyzer}

#  endpath this_is_the_end = {out}
}

